#!/bin/bash -e

# ------------------------------------------------------------------

check_db()
{

    psql -At \
         -d template1 \
         -c "SELECT COUNT(*) FROM pg_database WHERE datname = '$db_name'"
    return $?

} # end check_db()

create_build_properties()
{

    local build_dir="$1"
    local xnat_dir="$2"

    cat $build_dir/build.properties.template \
        | sed "s|%data_dir%|$data_dir|" \
        | sed "s|%db_name%|$db_name|" \
        | sed "s|%enable_csrf_token%|$enable_csrf_token|" \
        | sed "s|%enable_new_registrations%|$enable_new_registrations|" \
        | sed "s|%mail_admin%|$mail_admin|" \
        | sed "s|%mail_prefix%|$mail_prefix|" \
        | sed "s|%PGHOST%|$PGHOST|" \
        | sed "s|%PGPASSWORD%|$PGPASSWORD|" \
        | sed "s|%PGUSER%|$PGUSER|" \
        | sed "s|%project_name%|$project_name|" \
        | sed "s|%require_login%|$require_login|" \
        | sed "s|%security_channel%|$security_channel|" \
        | sed "s|%TOMCAT_HOME%|$TOMCAT_HOME|" \
        | sed "s|%xnat_url%|$xnat_url|" \
        > $xnat_dir/build.properties

    return 0

} # end create_build_properties()

psql_()
{

    local sql_file="$1"

    if [ $fix_psql_quotes ]
    then
        mv "$sql_file" "${sql_file}.orig"
        sed "s/\\\\'/''/g" "${sql_file}.orig" > "$sql_file"
    fi

    psql -U $PGUSER -h $PGHOST -f "$sql_file" $db_name

    return $?

} # end psql_()

# ------------------------------------------------------------------

progname=`basename $0`

if [ $# -eq 0 ]
then
    echo
    echo "usage: $progname [options] <build dir>"
    echo
    echo "options are:"
    echo
    echo "    -v verbose"
    echo
    exit 1
fi

getopt_results=`getopt -n $progname -o v -- "$@"`
if [ $? -ne 0 ] ; then exit 1 ; fi
eval set -- "$getopt_results"

verbose_flag=

while [ "$1" ]
do

    if [ "$1" = "-v" ]
    then
        verbose_flag=1
        shift
    fi

    if [ "$1" = "--" ]
    then
        shift
        break
    fi

    shift

done

# readlink -f will give us an absolute path
build_dir=`readlink -f "$1"`

# build commands' output is sent to log files and also to file 3
if [ $verbose_flag ]
then
    exec 3>&1
else
    exec 3> /dev/null
fi

# ------------------------------------------------------------------

. ./bin/common

check_exported PGHOST PGUSER PGPASSWORD JAVA_HOME
check_var xnat_version TOMCAT_HOME project_name db_name

if [ -d $log_dir ]
then
    echo "$progname: $log_dir exists" >&2
    exit 1
fi

if [ -d $xnat_dir ]
then
    echo "$progname: $xnat_dir exists" >&2
    exit 1
fi

if [ -d $data_dir ]
then
    echo "$progname: $data_dir exists" >&2
    exit 1
fi

conf_dir="conf/$xnat_version"
if [ ! -d "$conf_dir" ]
then
    echo "$progname: unsupported XNAT version \"$xnat_version\"" >&2
    exit 1
fi

. "$conf_dir/config"

if ! n_db=`check_db`
then
    echo "$progname: could not connect to database" >&2
    exit 1
fi

if [ $n_db -ne 0 ]
then
    echo "$progname: database $db_name exists" >&2
    exit 1
fi

check_tomcat

# ------------------------------------------------------------------

echo "parameters are:"
echo
echo "    PGHOST = $PGHOST"
echo "    PGUSER = $PGUSER"
echo "    PGPASSWORD = $PGPASSWORD"
echo "    JAVA_HOME = $JAVA_HOME"
echo "    xnat_version = $xnat_version"
echo "    TOMCAT_HOME = $TOMCAT_HOME"
echo "    project_name = $project_name"
echo "    db_name = $db_name"
echo "    xnat_repo = $xnat_repo"
echo "    data_dir = $data_dir"
echo "    xnat_url = $xnat_url"
echo "    mail_admin = $mail_admin"
echo "    mail_prefix = $mail_prefix"
echo "    require_login = $require_login"
echo "    enable_new_registrations = $enable_new_registrations"
echo "    security_channel = $security_channel"
echo "    enable_csrf_token = $enable_csrf_token"
echo

echo "--- setting up build..."

mkdir "$log_dir"
mkdir "$xnat_dir"
mkdir "$data_dir"
mkdir "$data_dir/build"
mkdir "$data_dir/ftp"
mkdir "$data_dir/cache"
mkdir "$data_dir/archive"
mkdir "$data_dir/prearchive"

echo "--- getting source..."

source_fname=`download $source`

echo "--- extracting source..."

tar zxvf $source_fname --strip 1 -C $xnat_dir >&3
rsync -av $conf_dir/xnat/ $xnat_dir/ >&3
create_build_properties $conf_dir $xnat_dir

echo "--- creating database..."

createdb $db_name

echo "--- setting up XNAT..."

cd $xnat_dir
./bin/setup.sh 2>&1 | tee $log_dir/setup.out >&3

if grep "BUILD FAILED" $log_dir/setup.out > /dev/null
then
    echo "$progname: setup failed" >&2
    exit 0
fi

echo "--- setting up database..."

cd deployments/$project_name
psql_ sql/${project_name}.sql 2>&1 | tee $log_dir/psql.out >&3
../../bin/StoreXML -l security/security.xml \
                   -allowDataDeletion true \
    | tee $log_dir/storexml_security.out >&3
../../bin/StoreXML -dir ./work/field_groups \
                   -u admin \
                   -p admin \
                   -allowDataDeletion true \
    | tee $log_dir/storexml_work.out >&3
cd ../..

echo "--- adding extensions..."

mv projects/$project_name/InstanceSettings.xml \
   projects/$project_name/InstanceSettings.xml.orig
sed 's/^[ \t]*<!--\(.*\)ext.xsd\(.*\)-->[ ]*$/\1ext.xsd\2/' \
    projects/$project_name/InstanceSettings.xml.orig \
    > projects/$project_name/InstanceSettings.xml

echo "--- deploying..."

./bin/update.sh -Ddeploy=true 2>&1 | tee $log_dir/update.out >&3
if grep "BUILD FAILED" $log_dir/update.out > /dev/null
then
    echo "$progname: deploy failed" >&2
    exit 0
fi

echo "--- updating database..."
psql_ deployments/$project_name/sql/${project_name}-update.sql 2>&1 \
    | tee $log_dir/psql-update.out >&3

echo
echo "exiting normally"
echo

exit 0

# eof
